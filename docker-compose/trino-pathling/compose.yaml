services:
  trino:
    image: docker.io/trinodb/trino:478@sha256:177bda76e5e6caf235de4502e10020a029d06dd2625709fbf5adf264b6295a1d
    ipc: none
    security_opt:
      - "no-new-privileges:true"
    cap_drop:
      - ALL
    privileged: false
    restart: unless-stopped
    environment:
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID:?}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY:?}"
    ports:
      - "127.0.0.1:8080:8080"
    volumes:
      - ./config/etc:/usr/lib/trino/etc:ro
      - ./config/catalog:/etc/trino/catalog:ro
    depends_on:
      - hive-metastore
      - minio

  kafka-fhir-to-delta:
    environment:
      METASTORE_URL: "thrift://hive-metastore:9083"

  hive-metastore-db:
    image: docker.io/library/postgres:18.2@sha256:b6b4d0b75c699a2c94dfc5a94fe09f38630f3b67ab0e1653ede1b7ac8e13c197
    ipc: private
    privileged: false
    restart: unless-stopped
    environment:
      POSTGRES_USER: hive
      POSTGRES_PASSWORD: ${HIVE_METASTORE_DB_PASSWORD:?}
      POSTGRES_DB: metastore
    volumes:
      - hive-metastore-db-data:/var/lib/postgresql:rw

  hive-metastore:
    image: ghcr.io/miracum/util-images/hive-metastore:v1.3.2@sha256:070c65748b0101133344b71a03ef427283c2c20a08783f98bd530ede4053cadf
    ipc: none
    security_opt:
      - "no-new-privileges:true"
    cap_drop:
      - ALL
    privileged: false
    restart: unless-stopped
    environment:
      SERVICE_NAME: metastore
      DB_DRIVER: postgres
      SERVICE_OPTS: "-Djavax.jdo.option.ConnectionUserName=hive -Djavax.jdo.option.ConnectionPassword=${HIVE_METASTORE_DB_PASSWORD:?}"
      AWS_ACCESS_KEY_ID: "admin"
      AWS_SECRET_ACCESS_KEY: "miniopass"
      AWS_DEFAULT_REGION: "eu-central-1"
    volumes:
      - ./config/hive-site.xml:/opt/hive/conf/hive-site.xml:ro
    depends_on:
      hive-metastore-db:
        condition: service_started

volumes:
  hive-metastore-db-data: {}
